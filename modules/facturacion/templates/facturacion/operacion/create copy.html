{% extends "base.html" %} {% block title %}Agregar Venta{% endblock %} {% block content %}
<div class="row mb-2 mb-xl-3">
    <div class="col-auto d-none d-sm-block">
        <h3><i class="fa-solid fa-file-invoice"></i> Agregar Venta</h3>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <form method="POST">
                    <table class="table table-sm table-bordered">
                        <tr>
                            <td style="width: 10%">Documento/Serie</td>
                            <td colspan="2" style="width: 10%">
                                <select class="form-select" id="serie_id" name="serie_id" required>
                                    {% if serie %} {% for item in serie %}
                                    <option value="{{ item.id }}">{% if item.tipo_comprobante == '01' %} Factura/{{ item.serie }} {% elif item.tipo_comprobante == '03' %} Boleta de venta/{{ item.serie }} {% endif %}</option>
                                    {% endfor %} {% endif %}
                                </select>
                            </td>
                            <td style="width: 10%">Tipo de venta</td>
                            <td>
                                <select class="form-select" id="TypeOperation" name="TypeOperation">
                                    <option value="01">Venta Interna</option>
                                    <option value="02">Exportación</option>
                                </select>
                            </td>
                            <td style="width: 12%">Moneda</td>
                            <td>
                                <select class="form-select" id="tipo_moneda" name="tipo_moneda">
                                    <option value="1">Soles</option>
                                    <option value="2">Dolares</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Fecha Emisión</td>
                            <td colspan="2"><input type="text" class="form-control" id="fecha_emision" name="fecha_emision" required /></td>
                            <td>F. Vencimiento</td>
                            <td><input type="text" class="form-control" id="fecha_vencimiento" name="fecha_vencimiento" required /></td>
                            <td>Tipo de cambio</td>
                            <td><input type="text" class="form-control" id="tipo_cambio" name="tipo_cambio" value="1" required /></td>
                        </tr>
                        <tr>
                            <td>Lista de Precio</td>
                            <td colspan="2"></td>
                            <td>Forma Pago</td>
                            <td>
                                <select class="form-select" id="forma_pago" name="forma_pago">
                                    <option value="009">Efectivo</option>
                                    <option value="999">Yape - Plin</option>
                                    <option value="006">Tarjeta de Crédito</option>
                                    <option value="001">Depósito en cuenta</option>
                                </select>
                            </td>
                            <td>Condición de Pago</td>
                            <td>
                                <select class="form-select form-select-sm" id="NumPayCondition" name="NumPayCondition">
                                    <option value="1">CONTADO</option>
                                    <option value="2">CREDITO</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>RUC</td>
                            <td>
                                <input type="hidden" id="personeria_id" name="personeria_id" />
                                <select class="form-select" id="ruc" name="ruc" style="width: 100%"></select>
                            </td>
                            <td style="width: 1%">
                                <button type="button" class="btn btn-primary"><i class="fa-solid fa-plus"></i></button>
                            </td>
                            <td>Razón Social</td>
                            <td><select class="form-select" id="razon_social" name="razon_social" style="width: 100%"></select></td>
                            <td>Dirección</td>
                            <td></td>
                        </tr>
                    </table>

                    <table class="table table-sm table-bordered">
                        <thead>
                            <td style="display: none"></td>
                            <th>Descripción</th>
                            <th style="width: 12%">Cantidad</th>
                            <th style="width: 12%">Precio Unitario</th>
                            <th style="width: 12%">Precio Total</th>
                            <th style="width: 3%"></th>
                        </thead>
                        <tr>
                            <td style="display: none">
                                <input type="text" id="codigo_search" name="codigo_search" />
                                <input type="text" id="unidad_search" name="unidad_search" />
                                <input type="text" id="id_search" name="id_search" />
                            </td>
                            <td><select class="form-select" id="producto_search" name="producto_search" style="width: 100%"></select></td>
                            <td><input type="text" class="form-control" id="cantidad_search" name="cantidad_search" placeholder="Cantidad" style="text-align: end" /></td>
                            <td><input type="text" class="form-control" id="precio_search" name="precio_search" placeholder="Precio Unitario" style="text-align: end" /></td>
                            <td><input type="text" class="form-control" id="total_search" name="total_search" placeholder="Total" style="text-align: end" /></td>
                            <td rowspan="2">
                                <button type="button" onclick="agregar_producto()" class="btn btn-sm btn-primary"><i class="fa-solid fa-plus"></i></button>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4"><input type="text" class="form-control" id="observacion_search" name="observacion_search" placeholder="Observaciones" /></td>
                        </tr>
                    </table>
                    <table id="productos" class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th style="width: 12%">Código</th>
                                <th style="width: 37%">Descripción</th>
                                <th style="width: 12%">Unidad</th>
                                <th style="width: 12%">Cantidad</th>
                                <th style="width: 12%">Precio Unitario</th>
                                <th style="width: 12%">Precio Total</th>
                                <th style="width: 3%"></th>
                            </tr>
                        </thead>
                        <tbody class="table-group-divider"></tbody>
                        <tfoot>
                            <tr>
                                <th style="width: 73%" colspan="4" rowspan="3"></th>
                                <th style="width: 12%">Base</th>
                                <th style="width: 12%"><input class="form-control form-control-sm" type="text" name="mto_oper_gravadas" id="mto_oper_gravadas" style="text-align: end" disabled /></th>
                                <th style="width: 3%" rowspan="3"></th>
                            </tr>
                            <tr>
                                <th style="width: 12%">IGV</th>
                                <th style="width: 12%"><input class="form-control form-control-sm" type="text" name="total_impuestos" id="total_impuestos" style="text-align: end" disabled /></th>
                            </tr>
                            <tr>
                                <th style="width: 12%">Total</th>
                                <th style="width: 12%"><input class="form-control form-control-sm" type="text" name="valor_venta" id="valor_venta" style="text-align: end" disabled /></th>
                            </tr>
                        </tfoot>
                    </table>
                    <table class="table table-sm table-borderless">
                        <tr>
                            <th style="width: 1%">Observaciones</th>
                            <th><input type="text" class="form-control" id="tipo_doc" name="tipo_doc" placeholder="Observaciones" /></th>
                        </tr>
                    </table>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('facturacion.operacion_index') }}" class="btn btn-secondary"> <i class="fas fa-times"></i> Cancelar </a>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Grabar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}

<link href="/static/select2/css/select2.min.css" rel="stylesheet" />
<script src="/static/select2/js/select2.full.min.js"></script>
<script src="/static/select2/js/i18n/es.js"></script>

<link href="/static/datepicker/css/bootstrap-datepicker.min.css" rel="stylesheet" />
<script src="/static/datepicker/js/bootstrap-datepicker.min.js"></script>
<script src="/static/datepicker/locales/bootstrap-datepicker.es.min.js"></script>

<style>
    .select2-search__field {
        width: 100% !important;
    }

    #productos.table-bordered,
    #productos.table-bordered th,
    #productos.table-bordered td {
        border: 1px solid #dee2e6 !important;
    }
</style>

<script>
    //productos = [];

    const cantidadInput = document.getElementById("cantidad_search");
    const precioInput = document.getElementById("precio_search");
    const totalInput = document.getElementById("total_search");

    function calcularTotal() {
        const cantidad = parseFloat(cantidadInput.value) || 0;
        const precio = parseFloat(precioInput.value) || 0;
        const total = cantidad * precio;
        totalInput.value = total.toFixed(2); // Muestra con 2 decimales
    }

    cantidadInput.addEventListener("input", calcularTotal);
    precioInput.addEventListener("input", calcularTotal);

    $(document).ready(function () {
        const hoy = new Date().toISOString().split("T")[0]; // Formato: "yyyy-mm-dd"
        document.getElementById("fecha_emision").value = hoy;
        document.getElementById("fecha_vencimiento").value = hoy;

        $("#fecha_emision").datepicker({
            format: "yyyy-mm-dd",
            language: "es",
            autoclose: true,
            todayHighlight: true,
        });

        $("#fecha_vencimiento").datepicker({
            format: "yyyy-mm-dd",
            language: "es",
            autoclose: true,
            todayHighlight: true,
        });

        $("#ruc").select2({
            ajax: {
                url: "/facturacion/operacion/search_personeria_numero_doc",
                dataType: "json",
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term, // término de búsqueda
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results,
                    };
                },
                cache: true,
            },
            placeholder: "Seleccione un tipo de comprobante",
            minimumInputLength: 2,
        });
        $("#ruc").on("select2:select", function (e) {
            const item = e.params.data;
            $("#razon_social").append(new Option(item.razon_social, item.id, true, true));
            $("#personeria_id").val(item.id || "");
        });
        
        $("#razon_social").select2({
            ajax: {
                url: "/facturacion/operacion/search_personeria_by_razon_social",
                dataType: "json",
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term, // término de búsqueda
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results,
                    };
                },
                cache: true,
            },
            placeholder: "Seleccione un tipo de comprobante",
            minimumInputLength: 2,
        });
        $("#razon_social").on("select2:select", function (e) {
            const item = e.params.data;
            $("#ruc").append(new Option(item.numero_doc, item.id, true, true));
            $("#personeria_id").val(item.id || "");
        });
        
        $("#producto_search").select2({
            ajax: {
                url: "/facturacion/operacion/search_producto",
                dataType: "json",
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term, // término de búsqueda
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results,
                    };
                },
                cache: true,
            },
            placeholder: "Seleccione un tipo de comprobante",
            minimumInputLength: 2,
        });
        $("#producto_search").on("select2:select", function (e) {
            const item = e.params.data;
            console.log(item);
            $("#precio_search").val(item.precio_soles || "");
            $("#cantidad_search").val(1);
            $("#codigo_search").val(item.codigo || "");
            $("#unidad_search").val(item.unidad_nombre || "");
            $("#id_search").val(item.id || "");

            calcularTotal();
        });
    });

    function agregar_producto() {
        // productos.push({
        //     codigo: $("#codigo_search").val(),
        //     unidad: $("#unidad_search").val(),
        //     producto_id: $("#id_search").val(),
        //     producto: $("#producto_search option:selected").text(),
        //     cantidad: $("#cantidad_search").val(),
        //     precio: $("#precio_search").val(),
        //     total: $("#total_search").val(),
        //     observacion: $("#observacion_search").val(),
        // });

        $("#productos tbody").append(`
            <tr>
                <td><input type="hidden" name="producto_id[]" value="${$("#id_search").val()}" >
                    <input class="d-none" type="text" name="codigo[]" value="${$("#codigo_search").val()}">${$("#codigo_search").val()}</td>
                <td><input class="d-none" type="text" name="producto[]" value="${$("#producto_search option:selected").text()}">${$("#producto_search option:selected").text()}</td>
                <td><input class="d-none" type="text" name="unidad[]" value="${$("#unidad_search").val()}">${$("#unidad_search").val()}</td>

                <td style="text-align: end;"><input class="d-none" type="text" name="cantidad[]" value="${$("#cantidad_search").val()}">${$("#cantidad_search").val()}</td>
                <td style="text-align: end;"><input class="d-none" type="text" name="precio[]" value="${$("#precio_search").val()}">${$("#precio_search").val()}</td>
                <td style="text-align: end;"><input class="d-none" type="text" name="total[]" value="${$("#total_search").val()}">${$("#total_search").val()}</td>
                <td><button type="button" onclick="eliminarFila(this)" class="btn btn-sm btn-danger"><i class="fa-solid fa-trash"></i></button</td>
            </tr>
        `);

        $("#id_search").val("");
        $("#codigo_search").val("");
        $("#producto_search").val(null).trigger("change");
        $("#unidad_search").val("");
        $("#cantidad_search").val("");
        $("#precio_search").val("");
        $("#total_search").val("");

        calcularTotales();
    }
    var tr;
    function eliminarFila(boton) {
        tr = $(boton).closest("tr");
        //id = tr.find('input[name="producto_id[]"]').val();
        //productos = productos.filter((m) => m.producto_id !== 1);
        $(boton).closest("tr").remove();
        calcularTotales();
    }

    function calcularTotales() {
        let total = 0,
            base = 0;

        document.querySelectorAll('#productos tbody input[name="total[]"]').forEach((input) => {
            total += parseFloat(input.value);
        });

        base = total / 1.18;
        igv = total - base;

        document.getElementById("mto_oper_gravadas").value = base.toFixed(2);
        document.getElementById("total_impuestos").value = igv.toFixed(2);
        document.getElementById("valor_venta").value = total.toFixed(2);
    }
</script>
{% endblock %}
