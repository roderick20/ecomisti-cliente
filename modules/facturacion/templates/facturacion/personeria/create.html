<!-- templates/productos/form.html -->
{% extends "base.html" %} {% block title %}{{ "Editar" if producto else "Nuevo" }} Producto{% endblock %} {% block content %}
<div class="row mb-2 mb-xl-3">
    <div class="col-auto d-none d-sm-block">
        <h3>Agregar Cliente</h3>
    </div>
</div>
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <form method="POST">
                    <div class="row">
                        <div class="col-5">
                            <div class="mb-3">
                                <label for="tipo_doc" class="form-label">Tipo de Documento <span class="text-danger">*</span></label>
                                <select class="form-select" id="tipo_doc" name="tipo_doc" required>
                                    <option value="6">RUC</option>
                                    <option value="1">DNI</option>
                                    <option value="4">CARNET DE EXTRANJERIA</option>
                                    <option value="7">PASAPORTE</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-5">
                            <div class="mb-3">
                                <label for="numero_doc" class="form-label">Número de Documento <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="numero_doc" name="numero_doc" required />
                            </div>
                        </div>
                        <div class="col-2">
                            <button type="button" class="btn btn-primary d-flex align-items-center px-2" style="margin-top: 1.7rem" onclick="buscarPersona()"><i class="fa-solid fa-magnifying-glass"></i> Buscar</button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="razon_social" class="form-label">Razón Social / Apellidos Nombre <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="razon_social" name="razon_social" required />
                    </div>

                    <div class="mb-3">
                        <label for="direccion" class="form-label">Dirección <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="direccion" name="direccion" />
                    </div>

                    <div class="mb-3" style="display: none">
                        <label for="ubigeo" class="form-label">Ubigeo <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="ubigeo" name="ubigeo" />
                    </div>

                    <div class="mb-3" style="display: none">
                        <label for="nombre_comercial" class="form-label">Nombre Comercial <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nombre_comercial" name="nombre_comercial" />
                    </div>

                    <div class="mb-3" style="display: none">
                        <label for="personeria_tipo" class="form-label">personeria_tipo <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="personeria_tipo" name="personeria_tipo" value="1" required />
                    </div>

                    <div class="mb-3" style="display: none">
                        <label for="contacto" class="form-label">contacto</label>
                        <input type="text" class="form-control" id="contacto" name="contacto" />
                    </div>

                    <div class="row" style="display: none">
                        <div class="col-5">
                            <div class="mb-3">
                                <label for="telefono" class="form-label">telefono</label>
                                <input type="text" class="form-control" id="telefono" name="telefono" />
                            </div>
                        </div>
                        <div class="col-7">
                            <div class="mb-3">
                                <label for="email" class="form-label">email</label>
                                <input type="text" class="form-control" id="email" name="email" />
                            </div>
                        </div>
                    </div>

                    <div class="row" style="display: none">
                        <div class="col-5">
                            <div class="mb-3">
                                <label for="cuenta_detraccion" class="form-label">cuenta_detraccion</label>
                                <input type="text" class="form-control" id="cuenta_detraccion" name="cuenta_detraccion" />
                            </div>
                        </div>
                        <div class="col-7">
                            <div class="mb-3">
                                <label for="cuenta_cci" class="form-label">cuenta_cci</label>
                                <input type="text" class="form-control" id="cuenta_cci" name="cuenta_cci" />
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('facturacion.personeria_index') }}" class="btn btn-secondary"> <i class="fas fa-times"></i> Cancelar </a>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Grabar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    async function buscarPersona() {
        const tipoDoc = document.getElementById("tipo_doc").value;
        const numeroDoc = document.getElementById("numero_doc").value.trim();
        const boton = document.querySelector('button[onclick="buscarPersona()"]');

        if (!numeroDoc) {
            alert("Por favor ingresa un número de documento.");
            return;
        }

        // Validar tipo de documento
        if (tipoDoc !== "1" && tipoDoc !== "6") {
            alert("Tipo de documento no válido.");
            return;
        }

        // Guardar texto original del botón
        const textoOriginal = boton.innerHTML;

        // Activar estado de carga
        boton.disabled = true;
        boton.innerHTML = "<span>Buscando...</span>"; // o usa un spinner si tienes

        let url = "";
        if (tipoDoc === "1") {
            url = `/facturacion/personeria/search_dni/${numeroDoc}`;
        } else if (tipoDoc === "6") {
            url = `/facturacion/personeria/search_ruc/${numeroDoc}`;
        } else {
            alert("Tipo de documento no válido.");
            return;
        }

        try {
            const response = await fetch(url);
            const data = await response.json();

            if (response.ok) {
                if (tipoDoc === "6") {
                    $("#razon_social").val(data.razonSocial);
                    $("#direccion").val(data.direccion);
                    $("#ubigeo").val(data.ubigeo);
                } else {
                    const nombreCompleto = [data.first_last_name || "", data.second_last_name || "", data.first_name || ""].filter((part) => part.trim() !== "").join(" ");

                    $("#razon_social").val(nombreCompleto);
                    $("#direccion").val("");
                    $("#ubigeo").val("");
                }
            } else {
                // Manejar respuesta con error (ej: 404, DNI no encontrado)
                alert("No se encontró información para el documento ingresado.");
            }
        } catch (error) {
            console.error("Error en la búsqueda:", error);
            alert("Ocurrió un error al buscar. Inténtalo de nuevo.");
        } finally {
            // Siempre restaurar el botón, incluso si hay error
            boton.disabled = false;
            boton.innerHTML = textoOriginal;
        }
    }
</script>
{% endblock %}
